<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚¿ã‚¹ã‚¯ç®¡ç† - Â¥100Mé”æˆ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    h1 { font-size: 28px; margin-bottom: 20px; color: #333; }
    
    /* è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  */
    .add-form {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .form-row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
    input, select, button {
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    input[type="text"] { flex: 1; min-width: 200px; }
    button {
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 500;
    }
    button:hover { background: #0056b3; }
    
    /* çµ±è¨ˆ */
    .stats {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
    }
    .stat-item { font-size: 14px; color: #666; }
    .stat-item strong { font-size: 20px; color: #333; display: block; }
    
    /* ãƒ“ã‚¸ãƒã‚¹ã‚«ãƒ†ã‚´ãƒª */
    .business-category {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 15px;
      overflow: hidden;
    }
    .business-header {
      padding: 15px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
    }
    .business-header:hover { opacity: 0.9; }
    .business-title { font-size: 18px; font-weight: 600; }
    .business-stats { font-size: 13px; opacity: 0.9; }
    .business-content { padding: 0; }
    .business-content.collapsed { display: none; }
    
    /* ä¸­é …ç›®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .sub-category {
      border-top: 1px solid #eee;
    }
    .sub-header {
      padding: 12px 20px;
      background: #f8f9fa;
      font-weight: 600;
      font-size: 15px;
      color: #495057;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .sub-icon { font-size: 18px; }
    
    /* ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ */
    .tasks { padding: 10px 20px 20px; display: flex; flex-direction: column; gap: 10px; }
    .task {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      border-left: 4px solid #ddd;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .task.completed { opacity: 0.6; background: #e9ecef; }
    .task.priority-high { border-left-color: #dc3545; }
    .task.priority-medium { border-left-color: #ffc107; }
    .task.priority-low { border-left-color: #28a745; }
    
    .task-content { flex: 1; }
    .task-title { font-size: 15px; font-weight: 500; color: #333; margin-bottom: 5px; }
    .task-meta { font-size: 13px; color: #666; }
    .task-meta span { margin-right: 15px; }
    
    .task-actions { display: flex; gap: 8px; }
    .task-actions button {
      padding: 6px 12px;
      font-size: 12px;
      background: #6c757d;
    }
    .task-actions button.done { background: #28a745; }
    .task-actions button.delete { background: #dc3545; }
    
    /* ç©ºçŠ¶æ…‹ */
    .empty {
      text-align: center;
      padding: 40px 20px;
      color: #999;
      font-size: 14px;
    }
    
    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 768px) {
      .form-row { flex-direction: column; }
      input[type="text"] { width: 100%; }
      .task { flex-direction: column; align-items: flex-start; }
      .task-actions { width: 100%; justify-content: flex-end; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“‹ ã‚¿ã‚¹ã‚¯ç®¡ç† - Â¥100Mé”æˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</h1>
    
    <!-- çµ±è¨ˆ -->
    <div class="stats" id="stats">
      <div class="stat-item">
        <strong id="stat-total">0</strong>
        ç·ã‚¿ã‚¹ã‚¯
      </div>
      <div class="stat-item">
        <strong id="stat-open">0</strong>
        æœªç€æ‰‹
      </div>
      <div class="stat-item">
        <strong id="stat-progress">0</strong>
        é€²è¡Œä¸­
      </div>
      <div class="stat-item">
        <strong id="stat-done">0</strong>
        å®Œäº†
      </div>
    </div>
    
    <!-- è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="add-form">
      <div class="form-row">
        <input type="text" id="task-title" placeholder="ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›..." />
        <select id="task-category">
          <option value="">ãƒ“ã‚¸ãƒã‚¹é¸æŠ...</option>
          <option value="ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆ">ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆ</option>
          <option value="TikTokåºƒå‘Šé‹ç”¨ä»£è¡Œ">TikTokåºƒå‘Šé‹ç”¨ä»£è¡Œ</option>
          <option value="ãƒ‡ã‚¸ã‚¿ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è²©å£²">ãƒ‡ã‚¸ã‚¿ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è²©å£²</option>
          <option value="ãƒã‚¦ãƒã‚¦ãƒ¬ã‚¿ãƒ¼">ãƒã‚¦ãƒã‚¦ãƒ¬ã‚¿ãƒ¼</option>
          <option value="ã‚·ã‚¹ãƒ†ãƒ åŸºç›¤">ã‚·ã‚¹ãƒ†ãƒ åŸºç›¤</option>
          <option value="å–¶æ¥­åŸºç›¤">å–¶æ¥­åŸºç›¤</option>
        </select>
        <select id="task-subcategory">
          <option value="">åˆ†é¡é¸æŠ...</option>
          <option value="ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°">ğŸ“Š ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°</option>
          <option value="å–¶æ¥­">ğŸ¤ å–¶æ¥­</option>
          <option value="ã‚³ãƒ³ãƒ†ãƒ³ãƒ„åˆ¶ä½œ">âœï¸ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„åˆ¶ä½œ</option>
          <option value="ã‚·ã‚¹ãƒ†ãƒ ">âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ </option>
          <option value="ãã®ä»–">ğŸ“Œ ãã®ä»–</option>
        </select>
        <select id="task-priority">
          <option value="ä¸­">å„ªå…ˆåº¦: ä¸­</option>
          <option value="é«˜">å„ªå…ˆåº¦: é«˜</option>
          <option value="ä½">å„ªå…ˆåº¦: ä½</option>
        </select>
        <input type="date" id="task-deadline" />
        <select id="task-assignee">
          <option value="">æ‹…å½“è€…...</option>
          <option value="takemasa">takemasa</option>
          <option value="ã‚Šã‚…ã†ã•ã‚“">ã‚Šã‚…ã†ã•ã‚“</option>
          <option value="ãƒãƒƒãƒãƒ§">ãƒãƒƒãƒãƒ§</option>
        </select>
        <button onclick="addTask()">è¿½åŠ </button>
      </div>
    </div>
    
    <!-- ãƒ“ã‚¸ãƒã‚¹ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ -->
    <div id="business-list"></div>
  </div>
  
  <script>
    const SUB_ICONS = {
      'ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°': 'ğŸ“Š',
      'å–¶æ¥­': 'ğŸ¤',
      'ã‚³ãƒ³ãƒ†ãƒ³ãƒ„åˆ¶ä½œ': 'âœï¸',
      'ã‚·ã‚¹ãƒ†ãƒ ': 'âš™ï¸',
      'ãã®ä»–': 'ğŸ“Œ'
    };
    
    // ã‚¿ã‚¹ã‚¯èª­ã¿è¾¼ã¿
    async function loadTasks() {
      const res = await fetch('/api/tasks');
      const tasks = await res.json();
      
      // ãƒ“ã‚¸ãƒã‚¹ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      const grouped = {};
      tasks.forEach(task => {
        const category = task.category || 'ãã®ä»–';
        if (!grouped[category]) grouped[category] = {};
        
        const subCategory = task.sub_category || 'ãã®ä»–';
        if (!grouped[category][subCategory]) grouped[category][subCategory] = [];
        
        grouped[category][subCategory].push(task);
      });
      
      const businessList = document.getElementById('business-list');
      businessList.innerHTML = '';
      
      if (Object.keys(grouped).length === 0) {
        businessList.innerHTML = '<div class="empty">ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>';
        return;
      }
      
      // ãƒ“ã‚¸ãƒã‚¹ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«è¡¨ç¤º
      Object.entries(grouped).sort().forEach(([category, subs]) => {
        const totalTasks = Object.values(subs).flat().length;
        const completedTasks = Object.values(subs).flat().filter(t => t.status === 'å®Œäº†').length;
        const progress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
        
        const businessDiv = document.createElement('div');
        businessDiv.className = 'business-category';
        businessDiv.innerHTML = `
          <div class="business-header" onclick="toggleBusiness(this)">
            <div class="business-title">${category}</div>
            <div class="business-stats">${completedTasks}/${totalTasks} å®Œäº† (${progress}%)</div>
          </div>
          <div class="business-content">
            ${Object.entries(subs).map(([subCat, subTasks]) => `
              <div class="sub-category">
                <div class="sub-header">
                  <span class="sub-icon">${SUB_ICONS[subCat] || 'ğŸ“Œ'}</span>
                  ${subCat} (${subTasks.length}ä»¶)
                </div>
                <div class="tasks">
                  ${subTasks.map(task => `
                    <div class="task priority-${task.priority === 'é«˜' ? 'high' : task.priority === 'ä¸­' ? 'medium' : 'low'} ${task.status === 'å®Œäº†' ? 'completed' : ''}">
                      <div class="task-content">
                        <div class="task-title">${task.title}</div>
                        <div class="task-meta">
                          <span>ID: ${task.id}</span>
                          <span>å„ªå…ˆåº¦: ${task.priority}</span>
                          ${task.deadline ? `<span>ç· åˆ‡: ${task.deadline}</span>` : ''}
                          ${task.assignee ? `<span>æ‹…å½“: ${task.assignee}</span>` : ''}
                          <span>çŠ¶æ…‹: ${task.status}</span>
                        </div>
                      </div>
                      <div class="task-actions">
                        ${task.status !== 'å®Œäº†' ? `
                          <button class="done" onclick="updateTaskStatus(${task.id}, 'å®Œäº†')">å®Œäº†</button>
                          <button onclick="updateTaskStatus(${task.id}, 'é€²è¡Œä¸­')">é€²è¡Œä¸­</button>
                        ` : `
                          <button onclick="updateTaskStatus(${task.id}, 'æœªç€æ‰‹')">å†é–‹</button>
                        `}
                        <button class="delete" onclick="deleteTask(${task.id})">å‰Šé™¤</button>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            `).join('')}
          </div>
        `;
        businessList.appendChild(businessDiv);
      });
    }
    
    // ãƒ“ã‚¸ãƒã‚¹ã‚«ãƒ†ã‚´ãƒªã®æŠ˜ã‚ŠãŸãŸã¿
    function toggleBusiness(header) {
      const content = header.nextElementSibling;
      content.classList.toggle('collapsed');
    }
    
    // çµ±è¨ˆèª­ã¿è¾¼ã¿
    async function loadStats() {
      const res = await fetch('/api/stats');
      const stats = await res.json();
      
      document.getElementById('stat-total').textContent = stats.total;
      
      const statusCounts = {};
      stats.byStatus.forEach(s => statusCounts[s.status] = s.count);
      
      document.getElementById('stat-open').textContent = statusCounts['æœªç€æ‰‹'] || 0;
      document.getElementById('stat-progress').textContent = statusCounts['é€²è¡Œä¸­'] || 0;
      document.getElementById('stat-done').textContent = statusCounts['å®Œäº†'] || 0;
    }
    
    // ã‚¿ã‚¹ã‚¯è¿½åŠ 
    async function addTask() {
      const title = document.getElementById('task-title').value.trim();
      if (!title) {
        alert('ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      const category = document.getElementById('task-category').value;
      const subCategory = document.getElementById('task-subcategory').value;
      const priority = document.getElementById('task-priority').value;
      const deadline = document.getElementById('task-deadline').value || null;
      const assignee = document.getElementById('task-assignee').value || null;
      
      await fetch('/api/tasks', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, category, sub_category: subCategory, priority, deadline, assignee })
      });
      
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
      document.getElementById('task-title').value = '';
      document.getElementById('task-deadline').value = '';
      
      loadTasks();
      loadStats();
    }
    
    // ã‚¿ã‚¹ã‚¯çŠ¶æ…‹æ›´æ–°
    async function updateTaskStatus(id, status) {
      await fetch(`/api/tasks/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status })
      });
      
      loadTasks();
      loadStats();
    }
    
    // ã‚¿ã‚¹ã‚¯å‰Šé™¤
    async function deleteTask(id) {
      if (!confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      
      await fetch(`/api/tasks/${id}`, { method: 'DELETE' });
      
      loadTasks();
      loadStats();
    }
    
    // Enterã‚­ãƒ¼ã§è¿½åŠ 
    document.getElementById('task-title').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') addTask();
    });
    
    // åˆå›èª­ã¿è¾¼ã¿
    loadTasks();
    loadStats();
    
    // 30ç§’ã”ã¨ã«è‡ªå‹•æ›´æ–°
    setInterval(() => {
      loadTasks();
      loadStats();
    }, 30000);
  </script>
</body>
</html>
